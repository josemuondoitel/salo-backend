// SALO Backend - Prisma Schema
// B2B2C Food Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  CUSTOMER
  RESTAURANT_OWNER
  ADMIN
}

enum RestaurantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  EXPRESS
  TRANSFER
}

enum PaymentStatus {
  PENDING
  VALIDATED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum AuditAction {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_CANCELLED
  RESTAURANT_ACTIVATED
  RESTAURANT_SUSPENDED
  RESTAURANT_CREATED
  ORDER_CREATED
  ORDER_UPDATED
  PAYMENT_VALIDATED
  PAYMENT_REJECTED
  ADMIN_ACTION
}

// =====================
// MODELS
// =====================

model User {
  id            String          @id @default(uuid())
  email         String          @unique
  passwordHash  String
  role          UserRole        @default(CUSTOMER)
  firstName     String
  lastName      String
  phone         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  restaurant    Restaurant?     @relation("RestaurantOwner")
  orders        Order[]         @relation("CustomerOrders")
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
}

model Restaurant {
  id            String            @id @default(uuid())
  name          String
  description   String?
  address       String
  phone         String
  status        RestaurantStatus  @default(PENDING)
  
  ownerId       String            @unique
  owner         User              @relation("RestaurantOwner", fields: [ownerId], references: [id])
  
  menuItems     MenuItem[]
  subscriptions Subscription[]
  orders        Order[]
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([status])
  @@index([ownerId])
}

model MenuItem {
  id            String      @id @default(uuid())
  name          String
  description   String?
  price         Decimal     @db.Decimal(10, 2)
  isAvailable   Boolean     @default(true)
  category      String
  
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  orderItems    OrderItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([restaurantId])
  @@index([isAvailable])
}

model Subscription {
  id              String              @id @default(uuid())
  status          SubscriptionStatus  @default(PENDING)
  startDate       DateTime?
  endDate         DateTime?
  monthlyAmount   Decimal             @db.Decimal(10, 2)
  
  restaurantId    String
  restaurant      Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  payment         Payment?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([status])
  @@index([endDate])
  @@index([restaurantId])
}

model Payment {
  id              String          @id @default(uuid())
  method          PaymentMethod
  status          PaymentStatus   @default(PENDING)
  amount          Decimal         @db.Decimal(10, 2)
  reference       String?
  validatedBy     String?
  validatedAt     DateTime?
  
  subscriptionId  String          @unique
  subscription    Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status])
}

model Order {
  id                String        @id @default(uuid())
  status            OrderStatus   @default(PENDING)
  totalAmount       Decimal       @db.Decimal(10, 2)
  notes             String?
  idempotencyKey    String        @unique
  
  customerId        String
  customer          User          @relation("CustomerOrders", fields: [customerId], references: [id])
  
  restaurantId      String
  restaurant        Restaurant    @relation(fields: [restaurantId], references: [id])
  
  items             OrderItem[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([customerId])
  @@index([restaurantId])
  @@index([status])
  @@index([idempotencyKey])
}

model OrderItem {
  id          String    @id @default(uuid())
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  menuItemId  String
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
}

model AuditLog {
  id              String        @id @default(uuid())
  action          AuditAction
  entityType      String
  entityId        String
  previousState   Json?
  newState        Json?
  metadata        Json?
  correlationId   String
  ipAddress       String?
  userAgent       String?
  
  userId          String?
  user            User?         @relation(fields: [userId], references: [id])
  
  createdAt       DateTime      @default(now())

  @@index([action])
  @@index([entityType, entityId])
  @@index([correlationId])
  @@index([createdAt])
}

model IdempotencyRecord {
  id            String    @id @default(uuid())
  key           String    @unique
  response      Json
  statusCode    Int
  expiresAt     DateTime
  
  createdAt     DateTime  @default(now())

  @@index([key])
  @@index([expiresAt])
}
