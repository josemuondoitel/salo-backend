// SALO Backend - Prisma Schema
// B2B2C Food Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  CUSTOMER
  RESTAURANT_OWNER
}

enum RestaurantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  EXPRESS
  TRANSFER
}

enum PaymentStatus {
  PENDING
  VALIDATED
  REJECTED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  REJECTED
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
  REPORTED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum AuditAction {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_CANCELLED
  RESTAURANT_ACTIVATED
  RESTAURANT_SUSPENDED
  RESTAURANT_CREATED
  RESTAURANT_DELETED
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_ACCEPTED
  ORDER_REJECTED
  ORDER_CANCELLED
  ORDER_REPORTED
  PAYMENT_VALIDATED
  PAYMENT_REJECTED
  ADMIN_ACTION
  LEDGER_ENTRY_CREATED
  MEDIA_UPLOADED
  GOOGLE_LOGIN
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
}

enum AnalyticsEventType {
  DISH_VIEWED
  MENU_VIEWED
  ORDER_CREATED
  RESTAURANT_VIEWED
}

enum LedgerAccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum MediaType {
  RESTAURANT_PROFILE
  DISH_PHOTO
  PRODUCT_PHOTO
  USER_PROFILE
}

// =====================
// MODELS
// =====================

model User {
  id            String          @id @default(uuid())
  email         String          @unique
  passwordHash  String?
  role          UserRole        @default(CUSTOMER)
  firstName     String
  lastName      String
  phone         String?
  
  // Google OAuth fields
  googleId      String?         @unique
  authProvider  String          @default("local")
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  restaurant    Restaurant?     @relation("RestaurantOwner")
  orders        Order[]         @relation("CustomerOrders")
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@index([googleId])
}

model Restaurant {
  id              String            @id @default(uuid())
  name            String
  description     String?
  address         String
  phone           String
  status          RestaurantStatus  @default(PENDING)
  
  // Cloudinary media reference
  profileImageId  String?
  profileImageUrl String?
  
  // Soft delete support
  deletedAt       DateTime?
  
  ownerId         String            @unique
  owner           User              @relation("RestaurantOwner", fields: [ownerId], references: [id])
  
  menuItems       MenuItem[]
  products        Product[]
  subscriptions   Subscription[]
  orders          Order[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([ownerId])
  @@index([deletedAt])
}

model MenuItem {
  id            String      @id @default(uuid())
  name          String
  description   String?
  price         Decimal     @db.Decimal(10, 2)
  isAvailable   Boolean     @default(true)
  category      String
  
  // Cloudinary media reference
  imageId       String?
  imageUrl      String?
  
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  orderItems    OrderItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([restaurantId])
  @@index([isAvailable])
}

// =====================
// PRODUCT MANAGEMENT (DDD)
// =====================

model Product {
  id            String        @id @default(uuid())
  name          String
  description   String?
  price         Decimal       @db.Decimal(10, 2)
  quantity      Int           @default(0)
  status        ProductStatus @default(ACTIVE)
  
  // Cloudinary media reference
  imageId       String?
  imageUrl      String?
  
  // Preventive / Future-proof fields
  isFeatured    Boolean       @default(false)
  sortOrder     Int           @default(0)
  metadata      Json?
  
  // Soft delete support
  deletedAt     DateTime?
  
  restaurantId  String
  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Relations for ingredients and modifiers
  ingredients   ProductIngredient[]
  modifierGroups ProductModifierGroup[]
  extras        ProductExtra[]
  orderProducts OrderProduct[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([restaurantId])
  @@index([status])
  @@index([deletedAt])
  @@index([isFeatured])
  @@index([sortOrder])
}

// =====================
// INGREDIENTS, MODIFIERS & EXTENSIONS
// =====================

model Ingredient {
  id            String              @id @default(uuid())
  name          String
  description   String?
  isAllergen    Boolean             @default(false)
  
  restaurantId  String
  
  products      ProductIngredient[]
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([restaurantId])
  @@index([isAllergen])
}

model ProductIngredient {
  id            String      @id @default(uuid())
  
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  ingredientId  String
  ingredient    Ingredient  @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  
  quantity      String?
  isOptional    Boolean     @default(false)
  
  createdAt     DateTime    @default(now())

  @@unique([productId, ingredientId])
  @@index([productId])
  @@index([ingredientId])
}

model ModifierGroup {
  id            String                  @id @default(uuid())
  name          String
  description   String?
  minSelections Int                     @default(0)
  maxSelections Int                     @default(1)
  isRequired    Boolean                 @default(false)
  
  restaurantId  String
  
  modifiers     Modifier[]
  products      ProductModifierGroup[]
  
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  @@index([restaurantId])
}

model Modifier {
  id              String        @id @default(uuid())
  name            String
  description     String?
  priceAdjustment Decimal       @db.Decimal(10, 2) @default(0)
  isDefault       Boolean       @default(false)
  
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([modifierGroupId])
}

model ProductModifierGroup {
  id              String        @id @default(uuid())
  
  productId       String
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  
  sortOrder       Int           @default(0)
  
  createdAt       DateTime      @default(now())

  @@unique([productId, modifierGroupId])
  @@index([productId])
  @@index([modifierGroupId])
}

model ProductExtra {
  id            String    @id @default(uuid())
  name          String
  description   String?
  price         Decimal   @db.Decimal(10, 2)
  isAvailable   Boolean   @default(true)
  
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([productId])
  @@index([isAvailable])
}

model Subscription {
  id              String              @id @default(uuid())
  status          SubscriptionStatus  @default(PENDING)
  startDate       DateTime?
  endDate         DateTime?
  monthlyAmount   Decimal             @db.Decimal(10, 2)
  
  // Ledger reference for payment tracking
  ledgerTransactionId String?
  
  restaurantId    String
  restaurant      Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  payment         Payment?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([status])
  @@index([endDate])
  @@index([restaurantId])
}

model Payment {
  id              String          @id @default(uuid())
  method          PaymentMethod
  status          PaymentStatus   @default(PENDING)
  amount          Decimal         @db.Decimal(10, 2)
  reference       String?
  validatedBy     String?
  validatedAt     DateTime?
  
  subscriptionId  String          @unique
  subscription    Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status])
}

model Order {
  id                String        @id @default(uuid())
  status            OrderStatus   @default(PENDING)
  totalAmount       Decimal       @db.Decimal(10, 2)
  notes             String?
  idempotencyKey    String        @unique
  
  // Rejection/Report fields
  rejectionReason   String?
  reportReason      String?
  cancellationReason String?
  
  customerId        String
  customer          User          @relation("CustomerOrders", fields: [customerId], references: [id])
  
  restaurantId      String
  restaurant        Restaurant    @relation(fields: [restaurantId], references: [id])
  
  items             OrderItem[]
  orderProducts     OrderProduct[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([customerId])
  @@index([restaurantId])
  @@index([status])
  @@index([idempotencyKey])
}

model OrderItem {
  id          String    @id @default(uuid())
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  menuItemId  String
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
}

// OrderProduct for the new Product model
model OrderProduct {
  id          String    @id @default(uuid())
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  
  // Snapshot of modifiers/extras at order time
  modifiers   Json?
  extras      Json?

  @@index([orderId])
  @@index([productId])
}

model AuditLog {
  id              String        @id @default(uuid())
  action          AuditAction
  entityType      String
  entityId        String
  previousState   Json?
  newState        Json?
  metadata        Json?
  correlationId   String
  ipAddress       String?
  userAgent       String?
  
  userId          String?
  user            User?         @relation(fields: [userId], references: [id])
  
  createdAt       DateTime      @default(now())

  @@index([action])
  @@index([entityType, entityId])
  @@index([correlationId])
  @@index([createdAt])
}

model IdempotencyRecord {
  id            String    @id @default(uuid())
  key           String    @unique
  response      Json
  statusCode    Int
  expiresAt     DateTime
  
  createdAt     DateTime  @default(now())

  @@index([key])
  @@index([expiresAt])
}

// =====================
// ADMIN - SEPARATE TABLE (MANDATORY)
// =====================

model Admin {
  id            String          @id @default(uuid())
  email         String          @unique
  passwordHash  String
  firstName     String
  lastName      String
  isActive      Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  auditLogs     AdminAuditLog[]

  @@index([email])
  @@index([isActive])
}

model AdminAuditLog {
  id              String        @id @default(uuid())
  action          String
  entityType      String
  entityId        String
  previousState   Json?
  newState        Json?
  metadata        Json?
  correlationId   String
  ipAddress       String?
  userAgent       String?
  
  adminId         String
  admin           Admin         @relation(fields: [adminId], references: [id])
  
  createdAt       DateTime      @default(now())

  @@index([action])
  @@index([entityType, entityId])
  @@index([correlationId])
  @@index([createdAt])
  @@index([adminId])
}

// =====================
// CLOUDINARY MEDIA
// =====================

model CloudinaryMedia {
  id              String        @id @default(uuid())
  publicId        String        @unique
  secureUrl       String
  mediaType       MediaType
  
  // Polymorphic reference - entity that owns this media
  entityType      String
  entityId        String
  
  width           Int?
  height          Int?
  format          String?
  bytes           Int?
  
  idempotencyKey  String        @unique
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([entityType, entityId])
  @@index([mediaType])
  @@index([publicId])
  @@index([idempotencyKey])
}

// =====================
// LEDGER - DOUBLE ENTRY ACCOUNTING (MANDATORY)
// =====================

model LedgerAccount {
  id              String              @id @default(uuid())
  code            String              @unique
  name            String
  accountType     LedgerAccountType
  description     String?
  isActive        Boolean             @default(true)
  
  debitEntries    LedgerEntry[]       @relation("DebitAccount")
  creditEntries   LedgerEntry[]       @relation("CreditAccount")
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([code])
  @@index([accountType])
  @@index([isActive])
}

model LedgerTransaction {
  id              String          @id @default(uuid())
  description     String
  reference       String?
  referenceType   String?
  referenceId     String?
  
  entries         LedgerEntry[]
  
  idempotencyKey  String          @unique
  
  createdAt       DateTime        @default(now())

  @@index([referenceType, referenceId])
  @@index([idempotencyKey])
  @@index([createdAt])
}

model LedgerEntry {
  id              String            @id @default(uuid())
  
  transactionId   String
  transaction     LedgerTransaction @relation(fields: [transactionId], references: [id])
  
  debitAccountId  String
  debitAccount    LedgerAccount     @relation("DebitAccount", fields: [debitAccountId], references: [id])
  
  creditAccountId String
  creditAccount   LedgerAccount     @relation("CreditAccount", fields: [creditAccountId], references: [id])
  
  amount          Decimal           @db.Decimal(15, 2)
  description     String?
  
  createdAt       DateTime          @default(now())

  @@index([transactionId])
  @@index([debitAccountId])
  @@index([creditAccountId])
  @@index([createdAt])
}

// =====================
// ANALYTICS EVENTS
// =====================

model AnalyticsEvent {
  id              String              @id @default(uuid())
  eventType       AnalyticsEventType
  
  restaurantId    String
  menuItemId      String?
  userId          String?
  
  metadata        Json?
  
  idempotencyKey  String              @unique
  
  createdAt       DateTime            @default(now())

  @@index([eventType])
  @@index([restaurantId])
  @@index([menuItemId])
  @@index([idempotencyKey])
  @@index([createdAt])
}
